import os
import logging
import threading
import random

from flask import Flask
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ChannelPostHandler,
    ContextTypes,
    filters,
)

# ---------- Flask –¥–ª—è Render ----------
app = Flask(__name__)

@app.route("/")
def home():
    return "‚úÖ Music Challenge Bot is alive!"


# ---------- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ----------
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO,
)
logger = logging.getLogger(__name__)

# ---------- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è ----------
BOT_TOKEN = os.environ.get("BOT_TOKEN")
CHANNEL_ID_RAW = os.environ.get("CHANNEL_ID")  # —Å—é–¥–∞ —Ç—ã –≤ Render –≤–ø–∏—Å–∞–ª–∞ -100...
CHANNEL_ID = None
if CHANNEL_ID_RAW:
    try:
        CHANNEL_ID = int(CHANNEL_ID_RAW)
    except ValueError:
        # –µ—Å–ª–∏ –ø–æ –æ—à–∏–±–∫–µ —É–∫–∞–∑–∞–ª–∏ —Ç–µ–∫—Å—Ç –≤–º–µ—Å—Ç–æ —á–∏—Å–ª–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–µ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –∫–∞–Ω–∞–ª—É
        logger.warning("CHANNEL_ID is not int, got %s", CHANNEL_ID_RAW)
        CHANNEL_ID = None

# ---------- –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ----------

RESOURCES = [
    "Pinterest: –≤–æ–∑—å–º–∏ –æ–¥–Ω—É –∫–∞—Ä—Ç–æ—á–∫—É –∏–∑ –¥–æ—Å–∫–∏ https://pin.it/kdBwVr8Mc",
    "–í–æ–∑—å–º–∏ —Å—Ç–∞—Ä—ã–π –ø—Ä–æ–µ–∫—Ç –∏ —Ä–∞–±–æ—Ç–∞–π –≤ –Ω—ë–º",
    "–í–æ–∑—å–º–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω, –∫–æ—Ç–æ—Ä—ã–π –µ—Å—Ç—å –ø–æ–¥ —Ä—É–∫–æ–π, –∏ –∑–∞–ø–∏—à–∏ —Å–µ–º–ø–ª —á–µ–≥–æ —É–≥–æ–¥–Ω–æ. –° –Ω–∏–º –∏ –±—É–¥–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å",
    "–≠—Ö–æ –ê–Ω—Ç–æ–Ω–∞ –ú–∞—Å–∫–µ–ª–∏–∞–¥–µ: —Ä–∞–±–æ—Ç–∞–µ–º –ø–æ –º–æ—Ç–∏–≤–∞–º –∫–Ω–∏–≥–∏ ¬´–¢–≤–æ–π –ø–µ—Ä–≤—ã–π —Ç—Ä–µ–∫¬ª",
    "–í–æ–∑—å–º–∏ –ª—é–±–æ–π –ª—É–ø –∏–∑ —Å–≤–æ–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏",
    "–í–æ–∑—å–º–∏ —Å–µ–º–ø–ª —Å–≤–æ–µ–≥–æ –≥–æ–ª–æ—Å–∞ (–º–æ–∂–Ω–æ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω)",
    "–í–æ–∑—å–º–∏ –æ—Ç—Ä—ã–≤–æ–∫ –ª—é–±–∏–º–æ–≥–æ —Ç—Ä–µ–∫–∞ (8 —Ç–∞–∫—Ç–æ–≤) –∏ –Ω–∞—Ä–µ–∂—å",
    "–í–æ–∑—å–º–∏ MIDI –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–π",
    "–ó–∞–ø–∏—à–∏ –ª—é–±–æ–π –±—ã—Ç–æ–≤–æ–π –∑–≤—É–∫ –≤–æ–∫—Ä—É–≥ –∏ –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ –∫–∞–∫ –æ—Å–Ω–æ–≤—É",
    "–í–æ–∑—å–º–∏ –ø—Ä–µ—Å–µ—Ç —Å–∏–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –æ–±—ã—á–Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å",
]

TASKS_COMMON = [
    "–°–æ–±–µ—Ä–∏ –∏–∑ —ç—Ç–æ–≥–æ 30‚Äì40 —Å–µ–∫—É–Ω–¥ —Ç—Ä–µ–∫–∞",
    "–°–¥–µ–ª–∞–π –≥—Ä—É–≤: —É–¥–∞—Ä–Ω—ã–µ + –±–∞—Å, –±–µ–∑ –º–µ–ª–æ–¥–∏–∏",
    "–°–¥–µ–ª–∞–π –∏–Ω—Ç—Ä–æ –Ω–∞ 15 —Å–µ–∫—É–Ω–¥, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –≤ Reels",
    "–°–¥–µ–ª–∞–π 2 –≤–µ—Ä—Å–∏–∏: –º–µ–¥–ª–µ–Ω–Ω—É—é –∏ –±—ã—Å—Ç—Ä—É—é",
    "–ü–µ—Ä–µ–≤–µ—Ä–Ω–∏ –∑–≤—É–∫ (reverse) –∏ –∏—Å–ø–æ–ª—å–∑—É–π –∫–∞–∫ –æ—Å–Ω–æ–≤—É",
    "–°–¥–µ–ª–∞–π 4-—Ç–∞–∫—Ç–æ–≤—ã–π –ª—É–ø, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –∑–∞—Ü–∏–∫–ª–∏—Ç—å",
    "–°–¥–µ–ª–∞–π –≤–∞—Ä–∏–∞–Ω—Ç ¬´—Ç–æ–ª—å–∫–æ –ø–µ—Ä–∫—É—Å—Å–∏—è¬ª",
    "–ù–∞–ø–æ–π –º–µ–ª–æ–¥–∏—é –∏ –¥–æ–±–∞–≤—å –∫ –Ω–µ–π –∞—Ä–∞–Ω–∂–∏—Ä–æ–≤–∫—É",
    "–°–¥–µ–ª–∞–π –¥—Ä–æ–Ω –∏–∑ –æ–¥–Ω–æ–π –Ω–æ—Ç—ã, –Ω–æ –¥–æ–±–∞–≤—å –¥–≤–∏–∂–µ–Ω–∏–µ –º–æ–¥—É–ª—è—Ü–∏–µ–π, —à—É–º–∞–º–∏ –∏–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–µ–π",
    "–°–¥–µ–ª–∞–π –∫–æ—Ä–æ—Ç–∫–∏–π –ª—É–ø –∏ –º–µ–¥–ª–µ–Ω–Ω–æ –º–µ–Ω—è–π —Ñ–∏–ª—å—Ç—Ä/—ç—Ñ—Ñ–µ–∫—Ç, —Å—Ä–∞–∑—É –∑–∞–ø–∏—à–∏ —ç—Ç–æ –≤ –∞—É–¥–∏–æ",
    "–°—ã–≥—Ä–∞–π –º–µ–ª–æ–¥–∏—é –æ–¥–Ω–æ–π —Ä—É–∫–æ–π –±–µ–∑ –æ–±–¥—É–º—ã–≤–∞–Ω–∏—è, –ø—Ä–æ—Å—Ç–æ –ø–æ —á—É–≤—Å—Ç–≤—É",
    "–°–¥–µ–ª–∞–π –≥—Ä—É–≤ –∏–∑ –æ–¥–Ω–æ–≥–æ —Ö–∞–π-—Ö—ç—Ç–∞, –¥–æ–±–∞–≤–ª—è—è –¥—ã—Ö–∞–Ω–∏–µ –ø–∞—É–∑–∞–º–∏ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–µ–π –≥—Ä–æ–º–∫–æ—Å—Ç–∏",
    "–ü—Ä–æ–ø–æ–π –±–∞—Å–æ–≤—É—é –ª–∏–Ω–∏—é –≥–æ–ª–æ—Å–æ–º, –∑–∞–ø–∏—à–∏ –∏ —Å—ã–≥—Ä–∞–π/—Å—ç–º–ø–ª–∏—Ä—É–π –ø–æ –Ω–µ–π",
    "–°–¥–µ–ª–∞–π —Å–æ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é: —Ç–æ –∂–µ —Å–∞–º–æ–µ, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ –∏ –º—è–≥—á–µ",
]

MASKELIADE_TASKS = [
    "¬´–≠–∫–≤–∞–ª–∞–π–∑–µ—Ä-—Å–ª–µ–ø–æ–π¬ª ‚Äî –æ—Ç–∫–ª—é—á–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é —ç–∫–≤–∞–ª–∞–π–∑–µ—Ä–∞, —Ä–∞–±–æ—Ç–∞–π —Ç–æ–ª—å–∫–æ —Å–ª—É—Ö–æ–º: –≤—ã—Ä–µ–∂—å –∏–ª–∏ –ø–æ–¥–Ω–∏–º–∏ –æ–¥–Ω—É —á–∞—Å—Ç–æ—Ç—É –Ω–∞ –æ–¥–Ω–æ–π –¥–æ—Ä–æ–∂–∫–µ",
    "¬´–†–∞–∑—Ä—ã–≤ —Ç–∏—à–∏–Ω—ã¬ª ‚Äî –≤—ã–±–µ—Ä–∏ —Å–ª–∞–±—É—é –ø–∞—Ä—Ç–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ö–∞–π-—Ö—ç—Ç—ã –∏–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç), —Å–¥–µ–ª–∞–π –µ—ë –≥—Ä–æ–º—á–µ –Ω–∞ 3‚Äì4 –¥–ë, –ø–æ—Ç–æ–º —Ä–µ–∑–∫–æ —Ç–∏—à–∏–Ω—É (‚àí6 –¥–ë) –Ω–∞ 2‚Äì3 —Ç–∞–∫—Ç–∞, –∑–∞—Ç–µ–º –æ–±—Ä–∞—Ç–Ω–æ",
    "¬´–≠—Ç–∞–ª–æ–Ω–Ω—ã–π —Å–ø–µ–∫—Ç—Ä¬ª ‚Äî –≤–æ–∑—å–º–∏ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–π—Å—è —Ç—Ä–µ–∫-—ç—Ç–∞–ª–æ–Ω, —Å—Ä–∞–≤–Ω–∏ —Å–ø–µ–∫—Ç—Ä, –≥—Ä–æ–º–∫–æ—Å—Ç—å –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–¥–æ–≥–Ω–∞—Ç—å —Å–≤–æ–π —Ç—Ä–µ–∫ –ø–æ–¥ —ç—Ç—É —Ñ–æ—Ä–º—É",
    "¬´–ê–Ω–∞–ª–æ–≥–æ–≤—ã–π —à—É–º¬ª ‚Äî –¥–æ–±–∞–≤—å –ª—ë–≥–∫–∏–π –≤–∏–Ω—Ç–∞–∂-—à—É–º –∏–ª–∏ —Å–∞—Ç—É—Ä–∞—Ü–∏—é ‚Äî –¥–æ –æ—â—É—â–µ–Ω–∏—è ¬´—Ç—ë–ø–ª–æ¬ª, –Ω–æ –Ω–µ ¬´–≥—Ä—è–∑–Ω–æ¬ª",
    "¬´–ì–ª—É–±–∏–Ω–∞ —Ç—Ä–µ–∫–∞¬ª ‚Äî –æ–¥–∏–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –±—É–¥–µ—Ç —Å–ø–µ—Ä–µ–¥–∏, –æ–¥–∏–Ω ‚Äî —Å–∑–∞–¥–∏, –æ–¥–∏–Ω ‚Äî –≤–¥–∞–ª–µ–∫–µ. –ò—Å–ø–æ–ª—å–∑—É–π –ø–∞–Ω–æ—Ä–∞–º—É, –≥—Ä–æ–º–∫–æ—Å—Ç—å –∏ —Ä–µ–≤–µ—Ä–±–µ—Ä–∞—Ü–∏—é, —á—Ç–æ–±—ã —ç—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å",
    "¬´–õ–æ–∫–∞—Ü–∏—è —Ç—Ä–µ–∫–∞¬ª ‚Äî –≤—ã–±–µ—Ä–∏ –ª–æ–∫–∞—Ü–∏—é: –ø–µ—â–µ—Ä–∞, –∫–æ–Ω—Ü–µ—Ä—Ç–Ω—ã–π –∑–∞–ª, –º–∞–ª–µ–Ω—å–∫–∞—è –∫–æ–º–Ω–∞—Ç–∫–∞. –ü–æ–¥–±–µ—Ä–∏ —Ä–µ–≤–µ—Ä–± –∏ –æ—Ç—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–∫, —á—Ç–æ–±—ã –∏–º–µ–Ω–Ω–æ —Ç–∞–º –∏–≥—Ä–∞–ª —Ç—Ä–µ–∫",
    "¬´–°–∞–±-—Å–∫–∞–ª—å–ø–µ–ª—å¬ª ‚Äî –≤—ã–±–µ—Ä–∏ –±–∞—Å-–¥–æ—Ä–æ–∂–∫—É: —Å—Ä–µ–∂—å –≤—Å—ë –Ω–∏–∂–µ ~30 –ì—Ü, –¥–æ–±–∞–≤—å –≥–∞—Ä–º–æ–Ω–∏–∫ –≤ —Ä–∞–π–æ–Ω–µ 200‚Äì400 –ì—Ü",
    "¬´–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –¥–∏—Å—Ç–æ—Ä—à–Ω¬ª ‚Äî –ø—Ä–æ–¥—É–±–ª–∏—Ä—É–π –±–∞—Å-–¥–æ—Ä–æ–∂–∫—É, –Ω–∞ –¥—É–±–ª–µ –≤–∫–ª—é—á–∏ –¥–∏—Å—Ç–æ—Ä—à–Ω, –¥–æ–±–∞–≤—å 10‚Äì15 % —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ –≤ –º–∏–∫—Å",
]

FOCUSES = [
    "–Ω–∞ –¥—Ä–∞–º-–≥—Ä—É–ø–ø–µ ‚Äî –¥–æ–±–µ–π—Å—è, —á—Ç–æ–±—ã –æ–Ω–∞ –∑–≤—É—á–∞–ª–∞ –∫–∞–∫ –µ–¥–∏–Ω–æ–µ —Ü–µ–ª–æ–µ",
    "–Ω–∞ –ø–∞–Ω–æ—Ä–∞–º–µ ‚Äî –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å —Å–≤–æ—ë –º–µ—Å—Ç–æ —Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞",
    "–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è—Ö ‚Äî —É —Ö–æ—Ç—è –±—ã –¥–≤—É—Ö –¥–æ—Ä–æ–∂–µ–∫ –¥–æ–ª–∂–Ω–∞ —á—Ç–æ-—Ç–æ –º–µ–Ω—è—Ç—å —Ä—É—á–∫–∞",
    "–Ω–∞ —Ç–µ–∫—Å—Ç—É—Ä–µ ‚Äî —Å–¥–µ–ª–∞–π –∑–≤—É–∫ ¬´—Å–≤–æ–∏–º¬ª: –∑–∞—à–µ–π–ø—å, –∏—Å–∫–∞–∑–∏, –∑–∞—Å—ç–º–ø–ª–∏—Ä—É–π",
    "–Ω–∞ –º–∏–Ω–∏–º–∞–ª–∏–∑–º–µ ‚Äî –Ω–µ –±–æ–ª—å—à–µ 5 –¥–æ—Ä–æ–∂–µ–∫ –≤ –ø—Ä–æ–µ–∫—Ç–µ",
    "–Ω–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞—Ö ‚Äî —Å–¥–µ–ª–∞–π –≤—Ö–æ–¥ –∏ –≤—ã—Ö–æ–¥ —Å–µ–∫—Ü–∏–∏ –∑–∞–º–µ—Ç–Ω—ã–º–∏",
    "–Ω–∞ —Ä–∏—Ç–º–µ ‚Äî –ø–æ–∏–≥—Ä–∞–π—Å—è —Å –ø–∞—É–∑–∞–º–∏ –∏ —Å–≤–∏–Ω–≥–æ–º, –Ω–µ –¥–æ–±–∞–≤–ª—è—è –Ω–æ–≤—ã—Ö –∑–≤—É–∫–æ–≤",
    "–Ω–∞ –±–∞—Å–µ ‚Äî —á—Ç–æ–±—ã –µ–≥–æ –±—ã–ª–æ —Å–ª—ã—à–Ω–æ –∏ –Ω–∞ –∫–æ–ª–æ–Ω–∫–∞—Ö, –∏ –≤ –Ω–∞—É—à–Ω–∏–∫–∞—Ö",
    "–Ω–∞ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ ‚Äî —Ä–µ–≤–µ—Ä–± –∏ –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Å–æ–∑–Ω–∞–Ω–Ω—ã–º–∏",
    "–Ω–∞ –≤—Ä–µ–º–µ–Ω–∏ ‚Äî –≤—ã–¥–µ–ª–∏ —Å–µ–±–µ 20 –º–∏–Ω—É—Ç –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Å—è",
    "–Ω–∞ –æ–¥–Ω–æ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ ‚Äî –≤—Å—ë –≤–æ–∫—Ä—É–≥ –Ω–µ–≥–æ, –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–æ–ª—å–∫–æ –ø–æ–¥–¥–µ—Ä–∂–∫–∞",
    "–Ω–∞ —Å–∞—É–Ω–¥-–¥–∏–∑–∞–π–Ω–µ ‚Äî –º–µ–Ω—è–π —Ç–µ–º–±—Ä, –∞ –Ω–µ –Ω–æ—Ç—ã",
    "–Ω–∞ —á–∏—Å—Ç–æ—Ç–µ ‚Äî —É–±–µ—Ä–∏ –≥—Ä—è–∑—å –≤–Ω–∏–∑—É —É –≤—Å–µ—Ö, –∫–æ–º—É –æ–Ω–∞ –Ω–µ –Ω—É–∂–Ω–∞",
    "¬´–∫–∞–∫ –±—É–¥—Ç–æ —ç—Ç–æ —Å–∞—É–Ω–¥—Ç—Ä–µ–∫¬ª ‚Äî –¥—É–º–∞–π –ø—Ä–æ –∫–∞—Ä—Ç–∏–Ω–∫—É, –∞ –Ω–µ –ø—Ä–æ —Ç–∞–Ω—Ü–ø–æ–ª",
]

# —Å—é–¥–∞ –±—É–¥–µ–º —Å–∫–ª–∞–¥—ã–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –ø–æ—Å—Ç—ã –∏–∑ –∫–∞–Ω–∞–ª–∞
CHANNEL_POSTS: list[str] = []

KEYBOARD = ReplyKeyboardMarkup(
    [
        ["ü•Å –ü–æ–ª—É—á–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ"],
        ["üëÄ –ß—Ç–æ —ç—Ç–æ –∑–∞ —Å–∏—Å—Ç–µ–º–∞?"],
        ["üé≤ –ú–Ω–µ –ø–æ–≤–µ–∑—ë—Ç!"],
    ],
    resize_keyboard=True,
)


# ---------- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ----------

def generate_task() -> str:
    resource = random.choice(RESOURCES)

    # –µ—Å–ª–∏ —Ä–µ—Å—É—Ä—Å ‚Äî –ú–∞—Å–∫–µ–ª–∏–∞–¥–µ, –±–µ—Ä—ë–º –∑–∞–¥–∞–Ω–∏–µ –∏–∑ –µ–≥–æ —Å–ø–∏—Å–∫–∞
    if resource.startswith("üëª –≠—Ö–æ –ê–Ω—Ç–æ–Ω–∞ –ú–∞—Å–∫–µ–ª–∏–∞–¥–µ"):
        task = random.choice(MASKELIADE_TASKS)
    else:
        task = random.choice(TASKS_COMMON)

    focus = random.choice(FOCUSES)

    text = (
        "üéõ –ú—É–∑—ã–∫–∞–ª—å–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ\n\n"
        f"**–†–µ—Å—É—Ä—Å:** {resource}\n\n"
        f"**–ó–∞–¥–∞–Ω–∏–µ:** {task}\n\n"
        f"**–§–æ–∫—É—Å:** {focus}"
    )
    return text


# ---------- Handlers ----------

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî —Ç–≤–æ–π –ø–∏–Ω–æ–∫ –Ω–∞ –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π –û–ª–∏–º–ø. –ñ–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –∏ –¥–∞–≤–∞–π —Ç–≤–æ—Ä–∏—Ç—å –≤–º–µ—Å—Ç–µ",
        reply_markup=KEYBOARD,
    )


async def text_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–±—ã—á–Ω—ã–µ —é–∑–µ—Ä—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è.
    –ê–ø–¥–µ–π—Ç—ã –∏–∑ –∫–∞–Ω–∞–ª–∞ —Å—é–¥–∞ –ù–ï –¥–æ–ª–∂–Ω—ã —Å–≤–∞–ª–∏–≤–∞—Ç—å—Å—è ‚Äî –ø–æ—ç—Ç–æ–º—É –ø–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞.
    """
    if not update.message:
        return  # –Ω–∞–ø—Ä–∏–º–µ—Ä, —ç—Ç–æ –±—ã–ª channel_post ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º

    text = (update.message.text or "").strip()

    # 1. –æ–ø–∏—Å–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
    if "—á—Ç–æ —ç—Ç–æ –∑–∞ —Å–∏—Å—Ç–µ–º–∞" in text.lower():
        await update.message.reply_text(
            "–Ø —Å–æ–±–∏—Ä–∞—é –∑–∞–¥–∞—á—É –∏–∑ —Ç—Ä—ë—Ö —á–∞—Å—Ç–µ–π:\n\n"
            "üß© –†–µ—Å—É—Ä—Å (–æ—Ç–∫—É–¥–∞ –≤–∑—è—Ç—å –∏–¥–µ—é)\n"
            "üß© –ó–∞–¥–∞–Ω–∏–µ (—á—Ç–æ —Å–¥–µ–ª–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å)\n"
            "üß© –§–æ–∫—É—Å (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –≤–∫–ª—é—á–∞–µ—Ç –º–æ–∑–≥)\n\n"
            "–¢–µ–ø–µ—Ä—å —Ç–µ–±–µ –Ω–µ –Ω—É–∂–Ω–æ –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å, —Å —á–µ–≥–æ –Ω–∞—á–∞—Ç—å, –∏ –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –Ω–∞—á–∞—Ç—å! –ñ–º–∏ –∫–Ω–æ–ø–∫—É üëá",
            reply_markup=KEYBOARD,
        )
        return

    # 2. –ø–æ–ª—É—á–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ
    if text == "ü•Å –ü–æ–ª—É—á–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ":
        task_text = generate_task()
        await update.message.reply_text(
            task_text,
            reply_markup=KEYBOARD,
            parse_mode="Markdown",
        )
        return

    # 3. –º–Ω–µ –ø–æ–≤–µ–∑—ë—Ç
    if text == "üé≤ –ú–Ω–µ –ø–æ–≤–µ–∑—ë—Ç!":
        if CHANNEL_POSTS:
            post = random.choice(CHANNEL_POSTS)
            await update.message.reply_text(post, reply_markup=KEYBOARD)
        else:
            await update.message.reply_text(
                "–ü–æ–∫–∞ –≤ –∫–æ–ø–∏–ª–∫–µ –ø—É—Å—Ç–æ. –ü–æ–≤–µ–∑—ë—Ç –≤ –¥—Ä—É–≥–æ–π —Ä–∞–∑!",
                reply_markup=KEYBOARD,
            )
        return

    # 4. –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ
    await update.message.reply_text("–õ—É—á—à–µ –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –∏ –ø–æ–≥–Ω–∞–ª–∏", reply_markup=KEYBOARD)


async def channel_post_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –õ–æ–≤–∏–º –ø–æ—Å—Ç—ã –∏–∑ –∫–∞–Ω–∞–ª–∞ –∏, –µ—Å–ª–∏ —Ç–∞–º –µ—Å—Ç—å –Ω—É–∂–Ω—ã–µ —Ö—ç—à—Ç–µ–≥–∏, —Å–∫–ª–∞–¥—ã–≤–∞–µ–º –≤ –ø–∞–º—è—Ç—å.
    """
    channel_post = update.channel_post
    if not channel_post:
        return

    # –µ—Å–ª–∏ —Ç—ã –∑–∞–¥–∞–ª–∞ CHANNEL_ID ‚Äî —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –Ω–µ–º—É
    if CHANNEL_ID is not None and channel_post.chat.id != CHANNEL_ID:
        return

    text = channel_post.text or channel_post.caption or ""
    lower = text.lower()

    needed_tags = ["#–∞–∫–∫–æ—Ä–¥—ã", "#–ª–∞–π—Ñ—Ö–∞–∫–∏", "#–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ", "#—Å–µ–º–ø–ª—ã", "#–ø–ª–∞–≥–∏–Ω—ã"]
    if any(tag in lower for tag in needed_tags):
        CHANNEL_POSTS.append(text)
        logger.info("Saved channel post from %s: %s", channel_post.chat.id, text[:80])


# ---------- –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ ----------

def run_telegram_bot():
    if not BOT_TOKEN:
        logger.error("BOT_TOKEN is not set")
        return

    application = ApplicationBuilder().token(BOT_TOKEN).build()

    # –∫–æ–º–∞–Ω–¥—ã/—Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ª—é–¥–µ–π
    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, text_handler))

    # –ø–æ—Å—Ç—ã –∏–∑ –∫–∞–Ω–∞–ª–∞
    application.add_handler(ChannelPostHandler(channel_post_handler))

    # –≤ –ø–æ—Ç–æ–∫–µ –Ω–µ–ª—å–∑—è –≤–µ—à–∞—Ç—å —Å–∏–≥–Ω–∞–ª—ã, –ø–æ—ç—Ç–æ–º—É stop_signals=None
    application.run_polling(
        allowed_updates=Update.ALL_TYPES,
        stop_signals=None,
    )


# ---------- entrypoint ----------
if __name__ == "__main__":
    # –±–æ—Ç –≤ —Ñ–æ–Ω–µ
    bot_thread = threading.Thread(target=run_telegram_bot, daemon=True)
    bot_thread.start()

    # flask –¥–ª—è render
    port = int(os.environ.get("PORT", 10000))
    app.run(host="0.0.0.0", port=port)
